<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Create your own adventure">
    <meta name="author" content="Matthew Gold">
    <link rel="shortcut icon" href="{{ url_for('static', filename='Images/favicon.ico') }}">

    <title>Build Your Own Adventure</title>

    <!-- Bootstrap core CSS -->
    <link href="{{ url_for('static', filename='CSS/bootswatch/bootstrap.readable.min.css') }}" rel="stylesheet" media="screen" title="main">
	<link href="{{ url_for('static', filename='CSS/bootstrap-switch.min.css') }}" rel="stylesheet">
    <link href="////cdnjs.cloudflare.com/ajax/libs/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="{{ url_for('static', filename='CSS/template.css') }}" rel="stylesheet">
	
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="container hidden-sm hidden-md hidden-lg">
		<div class="navbar-header">
			<a class="navbar-brand" href="AdventureEngine.html">Build Your Own Adventure</a>
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
			</button>
		</div>
		</div>
		<div class="container">
            <div class="navbar-header hidden-xs">
				<a class="navbar-brand" href="AdventureEngine.html">Build Your Own Adventure</a>
            </div>
            <ul class="nav navbar-nav navbar-right pull-right">
				<li><a href="javascript://" class="btn-nav"><button data-bind="fadeToggle: model.canEdit" type="button" class="btn btn-default" data-toggle="modal" data-target="#advMap">Adventure Map</button></a></li>
				<li><a id="lnkEdit" href="javascript://"><input class="btn" id="chkEdit" type="checkbox" data-bind="bootstrapSwitchOn: canEdit"/></a></li>
		    </ul>
            <div class="collapse navbar-collapse">
                <ul class="nav navbar-nav">
                    <li><a href="javascript:model.loadStory(Adventure.Stories.Tutorial);">Demo</a></li> <!-- li class="active" --> 
					
					<li class="dropdown">
						<a class="dropdown-toggle" data-toggle="dropdown" href="#" id="download">File <span class="caret"></span></a>
					    <ul class="dropdown-menu" aria-labelledby="download">
					    	<li><a href="javascript:saveAdv();"><i class="fa fa-fw fa-save"></i>Save Adventure</a></li>
					    	<li><a href="javascript:loadAdv();"><i class="fa fa-fw fa-cloud-download"></i>Load Adventure</a></li>
							<li class="divider"></li>
							<li><a href="javascript:model.loadStory(Adventure.Stories.New);"><i class="fa fa-fw fa-plus"></i>New Adventure</a></li>
							<li class="divider"></li>
							<li><a href="javascript:model.exportStory();"><i class="fa fa-fw fa-file-code-o"></i>Export JSON</a></li>
							<li><a href="javascript:model.importStory();"><i class="fa fa-fw fa-code"></i>Import JSON</a></li>
						</ul>
                    </li>
                    <li class="dropdown">
                      <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="download">Theme <span class="caret"></span></a>
                      <ul class="dropdown-menu" aria-labelledby="download">
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.readable.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Readable (Default)</a></li>
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootstrap.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Bootstrap (No Theme)</a></li>

                        <li class="divider"></li>
                        <li role="presentation" class="dropdown-header">Light Color Schemes</li>
                      
                        <!--<li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.amelia.min.css"><i class="icon-fixed-width icon-pencil"></i> Amelia</a></li>-->
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.cerulean.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Cerulean</a></li>
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.cosmo.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Cosmo</a></li>
                        <!--<li><a href="#" class="change-style-menu-item" rel="CSS/bootswatch/bootstrap.flatly.min.css"><i class="icon-fixed-width icon-pencil"></i> Flatly</a></li>-->
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.journal.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Journal</a></li>
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.lumen.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Lumen</a></li>
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.simplex.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Simplex</a></li>
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.spacelab.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Spacelab</a></li>
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.united.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> United</a></li>
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.yeti.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Yeti</a></li>

                        <li class="divider"></li>
                        <li role="presentation" class="dropdown-header">Dark Color Schemes</li>

                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.cyborg.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Cyborg</a></li>
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.slate.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Slate</a></li>
                        <li><a href="#" class="change-style-menu-item" rel="{{ url_for('static', filename='CSS/bootswatch/bootstrap.superhero.min.css') }}"><i class="icon-fixed-width icon-pencil"></i> Superhero</a></li>
                      </ul>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </div>
    <div class="story container">
		<div class="page is-hidden">
			<div class="contextmessage">
                <span id="spnSave" class="text-success is-hidden"><i class="fa fa-fw fa-check"></i> Save successful!</span>
                <span id="spnSaveConflict" class="text-danger is-hidden"><i class="fa fa-fw fa-exclamation"></i> There was a conflict. Please reload the adventure.</span>
                <span id="spnLoad" class="text-success is-hidden"><i class="fa fa-fw fa-check"></i><span></span></span>
				<!--<span data-bind="fadeToggle: model.canEdit"><label style="margin-right:6px;" for="chkEditAdvanced">Advanced Mode:</label><input id="chkEditAdvanced" class="icontext" type="checkbox" data-bind="checked: editAdvanced"/></span>-->
			</div>
			
            <div class=" row-fluid title">
                <h2 data-bind="html: story().title, contentEditable: canEdit"></h2>
                <p class="lead" data-bind="html: story().titleSubtext, contentEditable: canEdit"></p>
            </div>
			
			<span data-bind="fadeToggle: model.canEdit, retainWidth: true"><span style="padding:0 10px; color:#999;" data-bind="contentEditable: canEdit, text: currentPage().name"></span></span>
            <div class="well pagecontent">
				<div class="pagetext" data-bind="fadepage: stagePage">
                    <div id="dvHeightMatch">
                        <p class="editable-block" data-bind="contentEditable: canEdit, html: canEdit() ? currentPage().pageText : currentPage().parsedPageText"></p>
                        <ul class="pager choices">
					<!-- ko foreach: currentPage().choices -->
					<!-- ko if: $root.canEdit() || $data.input()===false -->
                            <li data-bind="css: {disabled: !$root.meetsRequirements($data.requirements())}">
								<a href="javascript://" class="choice" data-bind="click: $root.choose, popover: '#popoverContent', visible: $root.meetsRequirements($data.requirements()) || isSecret()===false || $root.canEdit, css: {'pager-reqmet-secret': isSecret(), 'pager-reqmet': $data.requirements().length && $root.meetsRequirements($data.requirements()), 'is-editable': $root.canEdit() }">
									<i class="fa" data-bind="css: {'fa-angle-right': input()===false, 'fa-pencil': input()===true}"></i>
									<span class="icontext editable-inline choicetext" onclick="if (model.canEdit()){selectElementContents(this);}" data-bind="html: caption, contentEditable: $root.canEdit"></span>
								</a>
							</li>
					<!-- /ko -->
					<!-- /ko -->
						</ul>
						
						<div class="row" style="margin-bottom:20px;" data-bind="visible: currentPage().hasTextInput() && !canEdit()">
							<div class="col-md-12"><i class="fa fa-pencil fa-fw"></i>
								<input type="text" placeholder="Enter text" data-bind="value: userInput, valueUpdate: 'afterkeydown', enterPress: choosePageMatchingInput" style="width:190px;"/> 
								<button class="btn btn-default btn-sm" data-bind="fadeToggle: userInput, click: choosePageMatchingInput">Submit</button>
								<span class="text-danger choice-invalid is-hidden">Invalid choice</span>
							</div>
						</div>
						
						<div class="row pagecontrols">
							<div class="col-md-12">
								<a href="javascript://" class="pagecontrol btn btn-link btn-sm" data-bind="fadeToggle: model.canStepBack, retainWidth: true, click: $root.stepBack"><i class="fa fa-angle-double-left"></i> Go Back </a>
								<div class="btn-group pagecontrol" >
										<a id="lnkNewChoice" href="#" data-target="#" data-toggle="dropdown" class="pager-newchoice dropdown-toggle btn btn-primary btn-sm" data-bind="fadeToggle: model.canEdit"><i class="fa fa-plus"></i><span class="icontext">New Choice</span></a>
										<ul class="dropdown-menu" role="menu" aria-labelledby="lnkNewChoice">
											<li class="dropdown-header">Links to</li>
											<li><a data-bind="click: newChoice" class="choicetrigger" href="#"><i class="fa fa-code-fork fa-fw"></i>New Page</a></li>
											<li data-bind="if: model.story().pages().length > 1"><a href="javascript://" data-bind="click: function(){model.mapLinkToExistingPage(true); model.currentPage().createNewChoice(1, 'Edit Me'); $('.choicetext:last').click();}"><i class="fa fa-sign-in fa-fw"></i>Existing Page</a></li>
										</ul>
								</div>
							</div>
						</div>
					</div>
				</div>
            </div>
			
			<div class="row">
            <!-- ko foreach: story().labelGroups -->
                <div class="col-md-6">
                    <fieldset class="labelgroup">
                        <legend data-bind="text: name"></legend>
                <!-- ko foreach: labels -->
                        <a class="label label-warning btn-sm" href="#" data-bind="fadeToggle: $root.meetsRequirements($data.requirements())"><i data-bind="css: icon" class="fa fa-fw"></i> <span data-bind="text: typeof($root.story().getVariableValue($data.variableName())) === 'boolean' ? $data.name() : $data.name() + ': ' + $root.story().getVariableValue($data.variableName())"></span></a>&nbsp;
                <!-- /ko -->
                    </fieldset>
                </div>
            <!-- /ko -->
			</div>
        </div>
    </div>

    <div id="popoverContent" class="is-hidden" data-bind="if: model.currentChoice()"> 
		<div class="row"> 
			<!-- ko if: model.story().getPage(model.currentChoice().nextPage()) -->
			<a href="javascript://" class="btn btn-link tt" data-bind="click: function() { model.stagePage(model.currentChoice().nextPage()); model.history.push(model.currentPage().id());}, attr: { title: model.story().getPage(model.currentChoice().nextPage()).name}" data-toggle="tooltip" data-placement="right">
				<i class="fa fa-angle-right fa-fw"></i>
				Go to this page
			</a>
			<!-- /ko -->
			<!-- ko ifnot: model.story().getPage(model.currentChoice().nextPage()) -->
			<span class="alert alert-danger">Page Deleted</span>
			<!-- /ko -->
			
		</div>
		<div class="row">
			<div class="col-sm-12"><input type="checkbox" data-bind="checked: model.currentChoice().input" /> Text Input</div>
		</div>
		<div class="row" data-bind="fadeToggle: model.currentChoice().input, retainWidth: true">
			<div class="col-sm-12">Aliases: <input placeholder="value1, value2, value3, etc..." type="text" data-bind="value: model.currentChoice().inputAliases" /></div>
		</div>
		<div class="row">
			<a href="javascript://" class="btn btn-link btn-sm" data-bind="click: function(){model.mapLinkToExistingPage(true);}">
				<i class="fa fa-sign-in fa-fw"></i> Link to a Different Page
			</a>
		</div>
		<div class="row">
			<a href="javascript://" class="btn btn-link btn-sm" onclick="confirmDelete('Are you sure you want to delete this choice? This cannot be undone.', 'Delete Choice', function(result){if(result){model.currentPage().deleteChoice(model.currentChoice().caption());}});"><i class="fa fa-trash-o fa-fw"></i> Delete Choice</a>
		</div>
		<!-- ko if: model.editAdvanced -->
		<fieldset><legend>Advanced</legend>
		<label title="Secret choices are hidden if the requirements are not met." class="tt" data-toggle="tooltip" data-placement="right"><input type="checkbox" data-bind="checked: model.currentChoice().isSecret" />  Secret</label>
		
        <div class="row">
			<div class="col-sm-6">
				<fieldset>
					<legend>Requirements</legend>
				<!-- ko foreach: model.currentChoice().requirements -->
						<div class="row">
							<div class="col-xs-4" data-bind="text: $data.variableName">Variable</div>
							<div class="col-xs-3" data-bind="text: $data.condition">Operator</div>
							<div class="col-xs-4" data-bind="text: $data.value">Value</div>
							<div class="col-md-1">Delete</div>
						</div>
				<!-- /ko -->
					<div><a href="javascript:model.currentChoice().addRequirement()"><i class="fa fa-plus-square-o fa-fw"></i><span class="icontext">Add Requirement</span></a></div>
				</fieldset>
			</div>
			<div class="col-sm-6">
				<fieldset>
					<legend>Commands</legend>
				<!-- ko foreach: model.currentChoice().commands -->
						<div class="row">
							<div class="col-md-3" data-bind="text: $data.variableName">Variable</div>
							<div class="col-md-3" data-bind="text: $data.operation">Operator</div>
							<div class="col-md-3" data-bind="text: $data.value">Value</div>
							<div class="col-md-3">Delete</div>
						</div>
				<!-- /ko -->
					<div><a href="javascript:model.currentChoice().addCommand()"><i class="fa fa-plus-square-o fa-fw"></i><span class="icontext">Add Command</span></a></div>
				</fieldset>
			</div>
		</div>
		</fieldset>
		<!-- /ko -->
    </div>
    
	<div id="advMap" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="adventureMapLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header tree-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<h4 class="modal-title" id="adventureMapLabel">Adventure Map</h4>
					<div class="input-group input-group-sm">
						<span class="input-group-addon"><i class="fa fa-search fa-fw"></i></span>
						<input type="text" class="form-control" placeholder="Search" data-bind="value: model.pageFilter, valueUpdate:'afterkeydown'"/>
					</div>
				</div>
				<div class="modal-body">
					<div id="storytree" class="tree" data-bind="foreach: model.filteredPages">
							<!-- ko ifnot: model.mapLinkToExistingPage -->
							<div class="row mapelement">
								<div class="col-sm-2">
									<a class="btn btn-link btn-sm" href="javascript://" data-bind="click: function() {$('#advMap').modal('hide'); model.stagePage($data.id()); model.history.push(model.currentPage().id());}"><i class="fa fa-angle-right"></i>&nbsp;&nbsp;<span data-bind="text: $data.name().substring(0,16), attr: {title: $data.name()}"></span></a>
                  <!-- ko if: $data.choices().length != 0 -->
                  <a class="btn btn-link btn-sm" href="javascript://" data-bind="click: function() { $('.choices-'+$data.id()).slideToggle('fast'); }"><i class="fa fa-angle-right"></i> <span data-bind="">Toggle Choices</span></a>
                  <!-- /ko -->
								</div>
								<div class="col-sm-8 mapelement-pagetext">
									<p class="icontext" style="display:inline;" data-bind="html: $data.pageText()"></p>
									<div class="mapelement-pagetext-overlay"></div>
								</div>
								<div class="col-sm-2">
									<a class="btn btn-link btn-sm" href="#" data-bind="visible: model.story().pages().length > 1,click: function(){confirmDelete('Are you sure you want to delete this page? This cannot be undone.', 'Delete Page', function(){$root.story().deletePage($data.id);});}"><i class="fa fa-trash-o">&nbsp;&nbsp;Delete page</i></a>
								</div>
							</div>
              <!-- ko if: $data.choices().length != 0 -->
              <div class="row mapchoices" style="display:none" data-bind="css: 'choices-' + $data.id()">
                <ul class="list-inline" data-bind="foreach: { data: $data.choices(), as: 'choice' }">
                  <li><a href="javascript://" data-bind="click: function() { $('#advMap').modal('hide'); model.stagePage(choice.nextPage()); model.history.push($parent.id()); }"><span data-bind="text: choice.caption"></span></a></li>
                </ul>
              </div>
							<!-- /ko -->
							<!-- /ko -->
							<!-- ko if: model.mapLinkToExistingPage -->
							<!-- ko if: $data.id() !== model.currentPage().id() -->
							<div class="row mapelement">
								<div class="col-sm-2">
									<a class="btn btn-primary btn-sm" href="javascript://" data-bind="click: function() {$('#advMap').modal('hide'); model.currentChoice().nextPage($data.id()); setTimeout(function(){$('.choicetext:last').click();}, 500);}"><i class="fa fa-sign-in"></i> <span data-bind="text: '  ' + $data.name()"></span></a>
								</div>
								<div class="col-sm-10 mapelement-pagetext">
									<p class="icontext" style="display:inline;" data-bind="html: $data.pageText()"></p>
									<div class="mapelement-pagetext-overlay"></div>
								</div>
							</div>
							<!-- /ko -->
							<!-- /ko -->
						<hr />
					</div>
				</div>
				<div class="modal-footer">
					<!-- bulk actions could go here --> 
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
    </div>


    <!-- Import Libraries and Models
    ================================================== -->
    <script src="{{ url_for('static', filename='Scripts/jquery-2.1.0.min.js') }}"></script>
	<script src="{{ url_for('static', filename='Scripts/knockout-3.0.0.js') }}"></script>
	<script src="{{ url_for('static', filename='Scripts/knockout.mapping-latest.js') }}"></script>
    <script src="{{ url_for('static', filename='Scripts/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='Scripts/jquery.transit.min.js') }}"></script>
    <script src="{{ url_for('static', filename='Scripts/bootstrap-switch.min.js') }}"></script>
	<script src="{{ url_for('static', filename='Scripts/bootbox.min.js') }}"></script>
	
	<script src="{{ url_for('static', filename='Scripts/adventure/Adventure.js') }}"></script>
	<script src="{{ url_for('static', filename='Scripts/adventure/EngineModel.js') }}"></script>
	<script src="{{ url_for('static', filename='Scripts/adventure/BindingHandlers.js') }}"></script>
	<script src="{{ url_for('static', filename='Scripts/adventure/Stories.js') }}"></script>
	<script src="{{ url_for('static', filename='Scripts/adventure/Utilities.js') }}"></script>
	<script src="{{ url_for('static', filename='Scripts/jquery.highlight.js') }}"></script>
    <script type="text/javascript">
        $(function () {
			$('.page').fadeIn();
            $('body').on('click', '.change-style-menu-item', function () {
                $('link[title="main"]').attr('href', $(this).attr('rel'));
            });
			
			$('body').on('click', function (e) {
				$('.choice').each(function () {
					if (!$(this).is(e.target) && $(this).has(e.target).length === 0 && $('.popover').has(e.target).length === 0 && !$(e.target).hasClass('choicetrigger')) {
						$(this).popover('hide');
					}
				});
			});
			
			$('#advMap').on('hidden.bs.modal', function() {
				model.mapLinkToExistingPage(false);
			});
			
			//todo: add a tutorial custom binding that can do this for any element
			$('#lnkEdit').popover({
				content: '<p class="text-primary">Click here to edit your adventure!</p>',
				trigger: 'manual',
				placement: 'bottom',
				html: true
			});
			window.setTimeout(function() {
				if(!model.canEdit()) {
					$('#lnkEdit').popover('show').click(function() {
						$('#lnkEdit').popover('hide')
					});
				}
			}, 3000);
        });
        
		// -- temporary for prototype use only --
			function saveAdv() {
				$.ajax({
					url: '{{ url_for('save') }}',
					type: 'POST',
					dataType: 'json',
					contentType: 'application/json',
					data: ko.toJSON(ko.mapping.toJS(model.story))
				}).done(function(response){
					model.story()._rev = response._rev; //revision needs to be updated each time we save. 
					model.story()._id = response._id; // updated the _id in case its the first save
					$('#spnSave').fadeIn().delay(3500).fadeOut('slow');
				}).fail(function(response){
					$('#spnSaveConflict').fadeIn().delay(3500).fadeOut('slow');
				});
			}
			function loadAdv() {
				$.ajax({
					url: '{{ url_for('alldocs') }}',
					type: 'GET',
					dataType: 'json'
				}).done(function(response) {
					var lst = $('<div></div>');
					$.each(response.rows, function(i, row) {
						lst.append($('<div style="margin-bottom: 10px;"><blockquote><button class="btn btn-primary" data-dismiss="modal" onclick="getAdv(\''+row.id+'\')">Load</button> &nbsp;'+row.value+'</blockquote></div>'));
					});
					bootbox.dialog({
						message: lst.html(),
						title: 'Load Adventure',
						buttons: {
							cancel: {
							  label: "Cancel",
							  className: "btn-default"
							}
						}
					});
				});
			}
			
			function getAdv(id) {
				$.ajax({
					url: '{{ url_for('loady', id='') }}'+id,
					type: 'GET',
					dataType: 'json'
				}).done(function(response){
					model.loadStory(response);
					$('#spnLoad span').html('Last Edited: ' + response.last_edited);
					$('#spnLoad').fadeIn().delay(3500).fadeOut('slow');

				}).fail(function(response){
					alert(response);
				});
			}
		// --------------------------------------
		var model = new Adventure.EngineModel(Adventure.Stories.New);
		ko.applyBindings(model);
    </script>
</body>
</html>
